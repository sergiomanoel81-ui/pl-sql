
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "TASY"."PROTOCOLO_SESSAO_V_2" ("NR_SEQUENCIA", "QT_GPID", "DT_INICIO_DIALISE_OLD", "NR_ATENDIMENTO", "TRATAMENTO", "CD_PESSOA_FISICA", "TURNO", "DT_CANCELAMENTO", "CD_UNIDADE_BASICA", "CD_SETOR_ATENDIMENTO", "DT_DIALISE", "DT_INICIO_DIALISE", "DT_FIM_DIALISE", "QT_PESO_PRE", "QT_PESO_POS", "NM_USUARIO", "IE_TRATAMENTO", "DS_ACESSO") DEFAULT COLLATION "USING_NLS_COMP"  AS 
  SELECT
  a.NR_SEQUENCIA,
  a.QT_GPID,
  a.DT_INICIO_DIALISE AS DT_INICIO_DIALISE_OLD,
  a.NR_ATENDIMENTO,
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica), 1, 150) || ' - ' || 
      CASE 
        WHEN MAX(pt.IE_TRATAMENTO) = 'HD' THEN 'Hemodiálise'
        WHEN MAX(pt.IE_TRATAMENTO) = 'IHDF' THEN 'Hemodiafiltração'
        WHEN MAX(pt.IE_TRATAMENTO) = 'CHDI' THEN 'Hemodiafiltração'
        ELSE MAX(pt.IE_TRATAMENTO)
      END AS TRATAMENTO,
  a.cd_pessoa_fisica,
  CASE 
      WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 04:00:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 10:29:59', 'dd/mm/yyyy HH24:MI:SS') THEN 'Primeiro Turno'
      WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 10:30:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 14:29:59', 'dd/mm/yyyy HH24:MI:SS') THEN 'Segundo Turno'
      WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 14:30:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 22:00:00', 'dd/mm/yyyy HH24:MI:SS') THEN 'Terceiro Turno'
      ELSE 'ERRO'
  END AS TURNO,
  a.DT_CANCELAMENTO,
  MAX(pa.CD_UNIDADE_BASICA) AS CD_UNIDADE_BASICA,
  MAX(pa.CD_SETOR_ATENDIMENTO) AS CD_SETOR_ATENDIMENTO,
  TO_CHAR(a.DT_DIALISE, 'DD/MM/YYYY') AS DT_DIALISE,
  CASE 
    WHEN a.DT_INICIO_DIALISE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.DT_INICIO_DIALISE, 'DD/MM HH24:MI')
  END AS DT_INICIO_DIALISE,
  CASE 
    WHEN a.DT_FIM_DIALISE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.DT_FIM_DIALISE, 'DD/MM HH24:MI')
  END AS DT_FIM_DIALISE,
  CASE 
    WHEN a.QT_PESO_PRE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.QT_PESO_PRE) || ' Kg'
  END AS QT_PESO_PRE,
  CASE 
    WHEN a.QT_PESO_POS IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.QT_PESO_POS) || ' Kg'
  END AS QT_PESO_POS,
  a.NM_USUARIO,
  MAX(pt.IE_TRATAMENTO) AS IE_TRATAMENTO,
  HD_Obter_Desc_Acesso(c.nr_seq_acesso) AS ds_acesso
FROM
  hd_dialise a
  LEFT JOIN hd_dialise_acesso c ON a.NR_SEQUENCIA = c.NR_SEQ_DIALISE
  LEFT JOIN PACIENTE_TRATAMENTO pt ON a.CD_PESSOA_FISICA = pt.CD_PESSOA_FISICA
  INNER JOIN HD_DIALISE_DIALISADOR dd ON a.NR_SEQUENCIA = dd.NR_SEQ_DIALISE
  INNER JOIN HD_PONTO_ACESSO pa ON dd.NR_SEQ_PONTO_ACESSO = pa.NR_SEQUENCIA
GROUP BY
  a.NR_SEQUENCIA,
  a.QT_GPID,
  a.DT_INICIO_DIALISE,
  a.NR_ATENDIMENTO,
  a.cd_pessoa_fisica,
  CASE 
    WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 04:00:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 10:29:59', 'dd/mm/yyyy HH24:MI:SS') THEN 'Primeiro Turno'
    WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 10:30:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 14:29:59', 'dd/mm/yyyy HH24:MI:SS') THEN 'Segundo Turno'
    WHEN a.DT_INICIO_DIALISE BETWEEN TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 14:30:00', 'dd/mm/yyyy HH24:MI:SS') AND TO_DATE(TO_CHAR(a.DT_INICIO_DIALISE, 'dd/mm/yyyy')||' 22:00:00', 'dd/mm/yyyy HH24:MI:SS') THEN 'Terceiro Turno'
    ELSE 'ERRO'
  END,
  a.DT_CANCELAMENTO,
  TO_CHAR(a.DT_DIALISE, 'DD/MM/YYYY'),
  CASE 
    WHEN a.DT_INICIO_DIALISE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.DT_INICIO_DIALISE, 'DD/MM HH24:MI')
  END,
  CASE 
    WHEN a.DT_FIM_DIALISE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.DT_FIM_DIALISE, 'DD/MM HH24:MI')
  END,
  CASE 
    WHEN a.QT_PESO_PRE IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.QT_PESO_PRE) || ' Kg'
  END,
  CASE 
    WHEN a.QT_PESO_POS IS NULL THEN 'Não informado'
    ELSE TO_CHAR(a.QT_PESO_POS) || ' Kg'
  END,
  a.NM_USUARIO,
  hd_obter_tratamento(a.cd_pessoa_fisica),
  HD_Obter_Desc_Acesso(c.nr_seq_acesso)
ORDER BY
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica), 1, 150) || ' - ' || 
      CASE 
        WHEN MAX(pt.IE_TRATAMENTO) = 'HD' THEN 'Hemodiálise'
        WHEN MAX(pt.IE_TRATAMENTO) = 'IHDF' THEN 'Hemodiafiltração'
        WHEN MAX(pt.IE_TRATAMENTO) = 'CHDI' THEN 'Hemodiafiltração'
        ELSE MAX(pt.IE_TRATAMENTO)
      END,
  MAX(a.DT_INICIO_DIALISE);


  GRANT SELECT ON "TASY"."PROTOCOLO_SESSAO_V_2" TO "TASY_CONSULT";
